{% extends "base.html" %}

{% block title %}Edit: {{ page.title }} - {{ super() }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="/.static/css/sweetalert2.min.css">
<script src="/.static/js/sweetalert2.min.js"></script>
<style>
    /* Component editor - more compact */
    .component-editor {
        margin: var(--space-md) 0;
        padding: var(--space-md) var(--space-lg);
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        transition: all 0.2s ease;
        width: 100%;
        box-sizing: border-box;
    }
    
    .component-editor:hover {
        border-color: var(--gray-300);
        box-shadow: var(--shadow-sm);
    }
    
    /* Highlight animation for newly added components */
    .component-highlight {
        animation: highlightComponent 2s ease-out;
    }
    
    @keyframes highlightComponent {
        0% {
            background-color: #fef3c7;
            border-color: var(--warning-color);
            transform: scale(1.02);
        }
        100% {
            background-color: var(--gray-50);
            border-color: var(--gray-200);
            transform: scale(1);
        }
    }
    
    .component-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-md);
        padding-bottom: var(--space-sm);
        border-bottom: 1px solid var(--gray-200);
    }
    
    .component-info {
        display: flex;
        align-items: center;
        gap: var(--space-md);
    }
    
    .component-type {
        font-weight: 600;
        color: var(--gray-700);
        text-transform: capitalize;
        font-size: 0.9375rem;
    }
    
    .component-position {
        font-size: 0.75rem;
        color: var(--gray-500);
        background: var(--gray-100);
        padding: 2px 8px;
        border-radius: 12px;
    }
    
    .component-actions {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
    }
    
    /* Form layouts - use more columns on wider screens */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-md);
        margin-bottom: var(--space-md);
    }
    
    @media (min-width: 1600px) {
        .form-row {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    @media (max-width: 1200px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
    
    .form-group {
        margin-bottom: var(--space-md);
    }
    
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    
    .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--gray-700);
        font-size: 0.875rem;
    }
    
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-sm);
        font-size: 0.9375rem;
        transition: all 0.15s ease;
        background-color: white;
    }
    
    .form-group input[type="text"]:focus,
    .form-group input[type="number"]:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-group textarea {
        min-height: 120px;
        resize: vertical;
        font-family: var(--font-mono);
        font-size: 0.875rem;
        line-height: 1.5;
        width: 100%;
    }
    
    /* Make content textareas larger on wide screens */
    @media (min-width: 1600px) {
        .form-group.full-width textarea {
            min-height: 200px;
        }
    }
    
    .form-group select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
    
    /* Buttons - more compact */
    .button {
        padding: 6px 14px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.15s ease;
        white-space: nowrap;
    }
    
    .button:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }
    
    .button:active {
        transform: translateY(0);
    }
    
    .button-success {
        background: var(--success-color);
    }
    
    .button-success:hover {
        background: #059669;
    }
    
    .button-danger {
        background: var(--danger-color);
    }
    
    .button-danger:hover {
        background: #dc2626;
    }
    
    .button-secondary {
        background: var(--gray-600);
    }
    
    .button-secondary:hover {
        background: var(--gray-700);
    }
    
    .button-small {
        padding: 4px 8px;
        font-size: 0.75rem;
    }
    
    .button-icon {
        padding: 4px 8px;
        font-size: 1rem;
        min-width: 28px;
        text-align: center;
    }
    
    .button-block {
        display: block;
        width: 100%;
        text-align: center;
    }
    
    /* Sidebar actions */
    .edit-sidebar {
        position: sticky;
        top: 80px;
        height: calc(100vh - 100px);
        overflow-y: auto;
        background-color: var(--gray-50);
    }
    
    .sidebar-actions {
        margin-bottom: var(--space-lg);
    }
    
    .sidebar-actions .button {
        margin-bottom: var(--space-sm);
    }
    
    .sidebar-divider {
        height: 1px;
        background: var(--gray-200);
        margin: var(--space-lg) 0;
    }
    
    .component-shortcuts {
        margin-top: var(--space-lg);
    }
    
    .component-shortcuts h4 {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-500);
        margin-bottom: var(--space-md);
    }
    
    .shortcut-button {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        margin-bottom: var(--space-xs);
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius-sm);
        color: var(--gray-700);
        font-size: 0.875rem;
        font-weight: 500;
        text-align: left;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .shortcut-button:hover {
        background: var(--gray-50);
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateX(2px);
    }
    
    .shortcut-icon {
        width: 20px;
        text-align: center;
    }
    
    .draft-status {
        font-size: 0.875rem;
        color: var(--gray-500);
        background: var(--gray-100);
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 500;
        text-align: center;
        margin-bottom: var(--space-md);
    }
    
    /* Add component section - hidden since we'll use sidebar shortcuts */
    .add-component-section {
        display: none;
    }
    
    .help-text {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 4px;
    }
    
    /* Empty state */
    .empty-state {
        text-align: center;
        padding: var(--space-2xl) var(--space-lg);
        color: var(--gray-500);
    }
    
    /* Override default form max-width for edit mode */
    .edit-mode form.edit-form {
        max-width: none;
        width: 100%;
    }
    
    .edit-mode {
        width: 100%;
    }
    
    /* Override container and content for edit mode to use full width */
    .main-container:has(.edit-sidebar) {
        max-width: none;
        width: 100%;
    }
    
    .main-container:has(.edit-sidebar) .content {
        padding: var(--space-lg) var(--space-xl);
        max-width: none;
    }
    
    @media (max-width: 1400px) {
        .main-container:has(.edit-sidebar) .content {
            padding: var(--space-md) var(--space-lg);
        }
    }
    
    /* Component list */
    .components-list {
        margin-bottom: var(--space-lg);
        width: 100%;
    }
    
    /* Compact blog summary editor */
    .blog-summary-editor .form-row {
        grid-template-columns: 1fr;
    }
    
    .blog-summary-editor .inline-fields {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--space-md);
    }
    
    @media (max-width: 768px) {
        .blog-summary-editor .inline-fields {
            grid-template-columns: 1fr;
        }
    }
    
    /* Template-specific styles */
    .template-preview {
        margin-top: 10px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background: white;
    }
    
    .template-card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .template-highlight {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
    }
    
    .template-quote {
        font-style: italic;
        border-left: 4px solid #6c757d;
        padding-left: 20px;
        color: #495057;
    }
    
    .template-with_title h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #343a40;
    }
</style>
<script>
function submitComponentsForm(action) {
    const form = document.getElementById('components-form');
    const actionInput = form.querySelector('input[name="action"]');
    actionInput.value = action;
    
    // Debug: Log all form inputs before submission
    console.log('=== FORM SUBMISSION DEBUG ===');
    console.log('Action:', action);
    
    const componentIds = form.querySelectorAll('input[name="component_ids"]');
    
    console.log('Component IDs found:', componentIds.length);
    
    form.submit();
}


function deleteComponent(componentId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "This will permanently delete this component",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            // First save all current component data
            const form = document.getElementById('components-form');
            const actionInput = form.querySelector('input[name="action"]');
            actionInput.value = 'delete_component';
            
            // Add the component ID to delete
            const deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = 'delete_component_id';
            deleteInput.value = componentId;
            form.appendChild(deleteInput);
            
            // Submit the form
            form.submit();
        }
    });
}

function addNewComponentType(componentType) {
    // Create a temporary form to submit the new component
    const form = document.createElement('form');
    form.method = 'post';
    form.style.display = 'none';
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'add_component';
    form.appendChild(actionInput);
    
    const typeInput = document.createElement('input');
    typeInput.type = 'hidden';
    typeInput.name = 'component_type';
    typeInput.value = componentType;
    form.appendChild(typeInput);
    
    const contentInput = document.createElement('input');
    contentInput.type = 'hidden';
    contentInput.name = 'content';
    contentInput.value = getEmptyContentForType(componentType);
    form.appendChild(contentInput);
    
    document.body.appendChild(form);
    form.submit();
}

function getEmptyContentForType(componentType) {
    
    // For all components, including image, just add an empty component
    // The user can upload images after the component is created
    let emptyContent = '';
    switch(componentType) {
        case 'text':
        case 'markdown':
        case 'html':
        case 'code':
            emptyContent = '';
            break;
        case 'image':
            // Create empty image component with placeholder
            emptyContent = JSON.stringify({
                src: '',
                alt: ''
            });
            break;
        case 'blog_summary':
            // Create default blog summary configuration
            emptyContent = JSON.stringify({
                parent_page_id: null,
                display_title: 'Latest Posts',
                item_count: 5,
                show_descriptions: true,
                sort_order: 'created_at_desc',
                template: 'cards'
            });
            break;
        default:
            emptyContent = '';
    }
    
    return emptyContent;
}

function addNewComponent() {
    const addForm = document.getElementById('add-component-form');
    const componentType = addForm.querySelector('select[name="component_type"]').value;
    addNewComponentType(componentType);
}

function uploadImageForComponent(componentId) {
    // Create a hidden file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    
    fileInput.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Check file size (10MB max)
        if (file.size > 10 * 1024 * 1024) {
            alert('File is too large. Maximum size is 10MB.');
            return;
        }
        
        // Generate slug from filename
        const slug = file.name
            .replace(/\.[^/.]+$/, '') // Remove extension
            .toLowerCase()
            .replace(/[^a-z0-9-_]/g, '-') // Replace invalid chars
            .replace(/-+/g, '-') // Remove multiple dashes
            .replace(/^-|-$/g, ''); // Remove leading/trailing dashes
        
        // Create form data
        const formData = new FormData();
        formData.append('image', file);
        formData.append('slug', slug);
        formData.append('title', file.name);
        formData.append('description', '');
        formData.append('component_id', componentId);
        
        // Show loading state
        const uploadArea = document.querySelector(`#component-${componentId} .image-upload-area`);
        if (uploadArea) {
            uploadArea.innerHTML = '<p style="color: #007bff;">Uploading image...</p>';
        }
        
        try {
            // Upload the image
            const response = await fetch('./.upload-component-image', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                // Update the component content
                updateImageComponent(componentId, result);
            } else {
                alert('Failed to upload image. Please try again.');
                location.reload();
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Failed to upload image. Please try again.');
            location.reload();
        }
    };
    
    // Trigger file selection
    fileInput.click();
}

function changeImage(componentId) {
    // Same as upload, just for existing images
    uploadImageForComponent(componentId);
}

function updateImageSlug(componentId, newSlug) {
    // Validate slug - only allow lowercase letters, numbers, hyphens, and underscores
    const validSlug = newSlug.toLowerCase().replace(/[^a-z0-9-_]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
    
    // Update the input value with validated slug
    const slugInput = document.getElementById(`slug_${componentId}`);
    if (slugInput && slugInput.value !== validSlug) {
        slugInput.value = validSlug;
    }
    
    // Update the hidden content input
    const contentInput = document.getElementById(`content_${componentId}`);
    if (contentInput) {
        try {
            const content = JSON.parse(contentInput.value);
            content.slug = validSlug;
            contentInput.value = JSON.stringify(content);
            
            // Update the image preview URL
            const imgPreview = document.querySelector(`#component-${componentId} .image-preview img`);
            if (imgPreview) {
                imgPreview.src = `/${validSlug}.${content.format}`;
            }
        } catch (e) {
            console.error('Failed to update slug:', e);
        }
    }
}

function updateImageDisplaySize(componentId) {
    const widthInput = document.getElementById(`display_width_${componentId}`);
    const heightInput = document.getElementById(`display_height_${componentId}`);
    const contentInput = document.getElementById(`content_${componentId}`);
    
    if (contentInput) {
        try {
            const content = JSON.parse(contentInput.value);
            
            // Store display dimensions (empty string means auto)
            content.display_width = widthInput.value.trim();
            content.display_height = heightInput.value.trim();
            
            contentInput.value = JSON.stringify(content);
            
            // Update the preview image style if needed
            const imgPreview = document.querySelector(`#component-${componentId} .image-preview img`);
            if (imgPreview) {
                if (content.display_width) {
                    imgPreview.style.width = content.display_width;
                } else {
                    imgPreview.style.width = '';
                }
                
                if (content.display_height) {
                    imgPreview.style.height = content.display_height;
                } else {
                    imgPreview.style.height = '';
                }
            }
        } catch (e) {
            console.error('Failed to update display size:', e);
        }
    }
}

function updateImageComponent(componentId, imageData) {
    // Update the hidden input with new image data
    const contentInput = document.getElementById(`content_${componentId}`);
    if (contentInput) {
        const newContent = {
            slug: imageData.slug,
            title: imageData.title || imageData.slug,
            description: imageData.description || '',
            format: imageData.format,
            file_path: imageData.file_path,
            original_name: imageData.original_name,
            mime_type: imageData.mime_type,
            size: imageData.size,
            width: imageData.width,
            height: imageData.height
        };
        contentInput.value = JSON.stringify(newContent);
        
        // Update the UI to show the uploaded image
        const componentEditor = document.getElementById(`component-${componentId}`);
        const contentGroup = componentEditor.querySelector('.form-group:last-child');
        
        contentGroup.innerHTML = `
            <label for="content_${componentId}">Content</label>
            <div class="image-preview" style="margin-bottom: 10px;">
                <img src="/${imageData.slug}.${imageData.format}" 
                     alt="${imageData.description || imageData.title}"
                     style="max-width: 200px; max-height: 200px; border: 1px solid #dee2e6; border-radius: 4px;">
            </div>
            <input type="hidden" 
                   id="content_${componentId}" 
                   name="component_contents" 
                   value='${JSON.stringify(newContent)}'>
            <div class="image-info" style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                <div class="form-row" style="margin-bottom: 10px;">
                    <div class="form-group" style="margin: 0;">
                        <label for="slug_${componentId}" style="font-size: 0.75rem; margin-bottom: 4px;">Slug</label>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" 
                                   id="slug_${componentId}" 
                                   value="${imageData.slug}" 
                                   onchange="updateImageSlug(${componentId}, this.value)"
                                   style="flex: 1; padding: 6px 10px; border: 1px solid var(--gray-300); border-radius: var(--border-radius-sm); font-size: 0.9375rem;">
                            <span style="color: #6c757d; font-size: 0.875rem;">.${imageData.format}</span>
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.75rem; margin-bottom: 4px;">Display Size</label>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" 
                                   id="display_width_${componentId}" 
                                   value="${newContent.display_width || ''}" 
                                   placeholder="auto"
                                   onchange="updateImageDisplaySize(${componentId})"
                                   style="width: 60px; padding: 6px 10px; border: 1px solid var(--gray-300); border-radius: var(--border-radius-sm); font-size: 0.9375rem;">
                            <span style="color: #6c757d;">√ó</span>
                            <input type="text" 
                                   id="display_height_${componentId}" 
                                   value="${newContent.display_height || ''}" 
                                   placeholder="auto"
                                   onchange="updateImageDisplaySize(${componentId})"
                                   style="width: 60px; padding: 6px 10px; border: 1px solid var(--gray-300); border-radius: var(--border-radius-sm); font-size: 0.9375rem;">
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 20px; font-size: 0.75rem; color: #6c757d;">
                    <span><strong>Format:</strong> ${imageData.format}</span>
                    <span><strong>Size:</strong> ${(imageData.size / 1024).toFixed(2)} KB</span>
                    ${imageData.width && imageData.height ? `<span><strong>Dimensions:</strong> ${imageData.width}√ó${imageData.height}</span>` : ''}
                </div>
            </div>
            <button type="button" 
                    class="button button-secondary button-small" 
                    style="margin-top: 10px;"
                    onclick="changeImage(${componentId})">
                üîÑ Change Image
            </button>
        `;
        
        // Auto-save the draft
        submitComponentsForm('save_draft');
    }
}

function moveComponent(componentId, direction) {
    // Save all current component data and move the component
    const form = document.getElementById('components-form');
    const actionInput = form.querySelector('input[name="action"]');
    actionInput.value = 'move_component';
    
    // Add the component ID and direction
    const moveIdInput = document.createElement('input');
    moveIdInput.type = 'hidden';
    moveIdInput.name = 'move_component_id';
    moveIdInput.value = componentId;
    form.appendChild(moveIdInput);
    
    const directionInput = document.createElement('input');
    directionInput.type = 'hidden';
    directionInput.name = 'move_direction';
    directionInput.value = direction;
    form.appendChild(directionInput);
    
    // Submit the form
    form.submit();
}

function updateBlogSummaryContent(componentId) {
    const contentInput = document.getElementById(`content_${componentId}`);
    if (!contentInput) return;
    
    // Get all the form values
    const parentSelect = document.getElementById(`blog_parent_${componentId}`);
    const titleInput = document.getElementById(`blog_title_${componentId}`);
    const countInput = document.getElementById(`blog_count_${componentId}`);
    const descriptionsCheck = document.getElementById(`blog_descriptions_${componentId}`);
    const sortSelect = document.getElementById(`blog_sort_${componentId}`);
    const templateSelect = document.getElementById(`blog_template_${componentId}`);
    
    // Build the content object
    const content = {
        parent_page_id: parentSelect.value ? parseInt(parentSelect.value) : null,
        display_title: titleInput.value.trim(),
        item_count: parseInt(countInput.value) || 5,
        show_descriptions: descriptionsCheck.checked,
        sort_order: sortSelect.value,
        template: templateSelect.value
    };
    
    // Update the hidden input
    contentInput.value = JSON.stringify(content);
}

// Smooth scroll to component if there's a hash in the URL
document.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash) {
        const element = document.querySelector(window.location.hash);
        if (element) {
            // Wait a bit for the page to fully render
            setTimeout(() => {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Add a highlight effect
                element.classList.add('component-highlight');
                setTimeout(() => {
                    element.classList.remove('component-highlight');
                }, 2000);
            }, 100);
        }
    }
});
</script>
{% endblock %}

{% block sidebar %}
<div class="edit-sidebar">
    <!-- Draft Status -->
    <div class="draft-status">Editing Draft</div>
    
    <!-- Action Buttons -->
    <div class="sidebar-actions">
        <button type="button" class="button button-block" onclick="submitComponentsForm('save_draft')">
            üíæ Save Draft
        </button>
        <button type="button" class="button button-success button-block" onclick="submitComponentsForm('publish_draft')">
            üöÄ Save &amp; Publish
        </button>
        <form method="post" style="margin: 0;">
            {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% endif %}
            <input type="hidden" name="action" value="discard_draft">
            <button type="submit" class="button button-danger button-block" 
                    onclick="return confirm('Are you sure you want to discard all draft changes?')">
                ‚ùå Discard Draft
            </button>
        </form>
        <a href="{{ current_path }}" class="button button-secondary button-block">
            ‚Üê Back to Page
        </a>
    </div>
    
    <div class="sidebar-divider"></div>
    
    <!-- Component Shortcuts -->
    <div class="component-shortcuts">
        <h4>Add Component</h4>
        {% for comp_type in ordered_component_types %}
        <button type="button" class="shortcut-button" onclick="addNewComponentType('{{ comp_type.type }}')">
            <span class="shortcut-icon">
                {% if comp_type.type == "text" %}üìù{% elif comp_type.type == "markdown" %}üìÑ{% elif comp_type.type == "html" %}üåê{% elif comp_type.type == "code" %}üíª{% elif comp_type.type == "image" %}üñºÔ∏è{% elif comp_type.type == "blog_summary" %}üì∞{% else %}üì¶{% endif %}
            </span>
            {{ comp_type.label }}
        </button>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="edit-mode">
    <!-- Components Form -->
    <form method="post" id="components-form" class="edit-form">
        {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {% endif %}
        <input type="hidden" name="action" value="save_draft">
        
        <!-- Components -->
        <div class="components-list">
            {% if components %}
                {% for component in components %}
                <div class="component-editor" id="component-{{ component.id }}">
                    <div class="component-header">
                        <div class="component-info">
                            <span class="component-type">{{ component.component_type|title }} Component</span>
                            <span class="component-position">#{{ component.position + 1 }}</span>
                        </div>
                        <div class="component-actions">
                            <!-- Debug: loop.index0={{ loop.index0 }}, loop.first={{ loop.first }}, loop.last={{ loop.last }}, total={{ components|length }} -->
                            {% if not loop.first %}
                            <button type="button" class="button button-secondary button-icon" onclick="moveComponent({{ component.id }}, 'up')" title="Move Up">‚Üë</button>
                            {% else %}
                            <!-- Move up button hidden: loop.first is true -->
                            {% endif %}
                            {% if not loop.last %}
                            <button type="button" class="button button-secondary button-icon" onclick="moveComponent({{ component.id }}, 'down')" title="Move Down">‚Üì</button>
                            {% else %}
                            <!-- Move down button hidden: loop.last is true -->
                            {% endif %}
                            <button type="button" class="button button-danger button-small" onclick="deleteComponent({{ component.id }})">Delete</button>
                        </div>
                    </div>
                    
                    <input type="hidden" name="component_ids" value="{{ component.id }}">
                    <input type="hidden" name="component_types" value="{{ component.component_type }}">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="title_{{ component.id }}">Title (optional)</label>
                            <input type="text" 
                                   id="title_{{ component.id }}" 
                                   name="component_titles" 
                                   value="{{ component.title|default(value='') }}"
                                   placeholder="Enter component title...">
                        </div>
                        
                        <div class="form-group">
                            <label for="template_{{ component.id }}">Display Template</label>
                            <select id="template_{{ component.id }}" name="component_templates">
                                {% set templates = get_component_templates(type=component.component_type) %}
                                {% for template in templates %}
                                    <option value="{{ template }}" {% if component.template == template %}selected{% endif %}>
                                        {{ template | replace(from="_", to=" ") | title }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="content_{{ component.id }}">Content</label>
                        {% if component.component_type == "text" or component.component_type == "markdown" %}
                            <textarea id="content_{{ component.id }}" 
                                      name="component_contents" 
                                      required>{{ component.content.text|default(value='') }}</textarea>
                            <div class="help-text">
                                {% if component.component_type == "markdown" %}
                                Markdown formatting is supported
                                {% else %}
                                Plain text or HTML
                                {% endif %}
                            </div>
                        {% elif component.component_type == "html" %}
                            <textarea id="content_{{ component.id }}" 
                                      name="component_contents" 
                                      required>{{ component.content.html|default(value='') }}</textarea>
                            <div class="help-text">Raw HTML content</div>
                        {% elif component.component_type == "code" %}
                            <textarea id="content_{{ component.id }}" 
                                      name="component_contents" 
                                      required>{{ component.content.code|default(value='') }}</textarea>
                            <div class="help-text">Code content</div>
                        {% elif component.component_type == "image" %}
                            {% if component.content.slug %}
                                <!-- New format with uploaded image -->
                                <div class="image-preview" style="margin-bottom: 10px;">
                                    <img src="/{{ component.content.slug }}.{{ component.content.format }}" 
                                         alt="{{ component.content.description|default(value=component.content.title) }}"
                                         style="max-width: 200px; max-height: 200px; border: 1px solid #dee2e6; border-radius: 4px;">
                                </div>
                                <input type="hidden" 
                                       id="content_{{ component.id }}" 
                                       name="component_contents" 
                                       value="{{ component.content|json_encode }}">
                                <div class="image-info" style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                    <div class="form-row" style="margin-bottom: 10px;">
                                        <div class="form-group" style="margin: 0;">
                                            <label for="slug_{{ component.id }}" style="font-size: 0.75rem; margin-bottom: 4px;">Slug</label>
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <input type="text" 
                                                       id="slug_{{ component.id }}" 
                                                       value="{{ component.content.slug }}" 
                                                       onchange="updateImageSlug({{ component.id }}, this.value)"
                                                       style="flex: 1;">
                                                <span style="color: #6c757d; font-size: 0.875rem;">.{{ component.content.format }}</span>
                                            </div>
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label style="font-size: 0.75rem; margin-bottom: 4px;">Display Size</label>
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <input type="text" 
                                                       id="display_width_{{ component.id }}" 
                                                       value="{{ component.content.display_width|default(value='') }}" 
                                                       placeholder="auto"
                                                       onchange="updateImageDisplaySize({{ component.id }})"
                                                       style="width: 60px;">
                                                <span style="color: #6c757d;">√ó</span>
                                                <input type="text" 
                                                       id="display_height_{{ component.id }}" 
                                                       value="{{ component.content.display_height|default(value='') }}" 
                                                       placeholder="auto"
                                                       onchange="updateImageDisplaySize({{ component.id }})"
                                                       style="width: 60px;">
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 20px; font-size: 0.75rem; color: #6c757d;">
                                        <span><strong>Format:</strong> {{ component.content.format }}</span>
                                        <span><strong>Size:</strong> {{ (component.content.size / 1024)|round(precision=2) }} KB</span>
                                        {% if component.content.width and component.content.height %}
                                        <span><strong>Dimensions:</strong> {{ component.content.width }}√ó{{ component.content.height }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <button type="button" 
                                        class="button button-secondary button-small" 
                                        style="margin-top: 10px;"
                                        onclick="changeImage({{ component.id }})">
                                    üîÑ Change Image
                                </button>
                            {% else %}
                                <!-- No image uploaded yet -->
                                <div class="image-upload-area" style="border: 2px dashed #007bff; border-radius: 8px; padding: 20px; text-align: center; background: #f8f9fa;">
                                    <p style="margin: 0 0 10px 0; color: #6c757d;">No image uploaded yet</p>
                                    <input type="hidden" 
                                           id="content_{{ component.id }}" 
                                           name="component_contents" 
                                           value="{{ component.content|json_encode }}">
                                    <button type="button" 
                                            class="button" 
                                            onclick="uploadImageForComponent({{ component.id }})">
                                        üìÅ Upload Image
                                    </button>
                                    <div class="help-text" style="margin-top: 10px;">
                                        Click to upload an image file (JPG, PNG, GIF, WebP, SVG)
                                    </div>
                                </div>
                            {% endif %}
                        {% elif component.component_type == "blog_summary" %}
                            <div class="blog-summary-editor">
                                <input type="hidden" 
                                       id="content_{{ component.id }}" 
                                       name="component_contents" 
                                       value="{{ component.content|json_encode }}">
                                
                                <div class="form-group">
                                    <label for="blog_parent_{{ component.id }}">Parent Page</label>
                                    <select id="blog_parent_{{ component.id }}" 
                                            onchange="updateBlogSummaryContent({{ component.id }})"
                                            style="width: 100%;">
                                        <option value="">Select a parent page...</option>
                                        {% for p in all_pages %}
                                            <option value="{{ p.id }}" 
                                                    {% if component.content.parent_page_id == p.id %}selected{% endif %}>
                                                {{ p.title }} ({{ p.slug }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="blog_title_{{ component.id }}">Display Title</label>
                                    <input type="text" 
                                           id="blog_title_{{ component.id }}" 
                                           value="{{ component.content.display_title|default(value='') }}"
                                           onchange="updateBlogSummaryContent({{ component.id }})"
                                           placeholder="e.g., Latest Posts">
                                </div>
                                
                                <div class="form-group">
                                    <label for="blog_count_{{ component.id }}">Number of Items</label>
                                    <input type="number" 
                                           id="blog_count_{{ component.id }}" 
                                           value="{{ component.content.item_count|default(value=5) }}"
                                           min="1" max="50"
                                           onchange="updateBlogSummaryContent({{ component.id }})">
                                </div>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" 
                                               id="blog_descriptions_{{ component.id }}"
                                               {% if component.content.show_descriptions %}checked{% endif %}
                                               onchange="updateBlogSummaryContent({{ component.id }})">
                                        Show descriptions
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label for="blog_sort_{{ component.id }}">Sort Order</label>
                                    <select id="blog_sort_{{ component.id }}" 
                                            onchange="updateBlogSummaryContent({{ component.id }})">
                                        <option value="created_at_desc" {% if component.content.sort_order == "created_at_desc" %}selected{% endif %}>
                                            Newest First
                                        </option>
                                        <option value="created_at_asc" {% if component.content.sort_order == "created_at_asc" %}selected{% endif %}>
                                            Oldest First
                                        </option>
                                        <option value="title_asc" {% if component.content.sort_order == "title_asc" %}selected{% endif %}>
                                            Title A-Z
                                        </option>
                                        <option value="title_desc" {% if component.content.sort_order == "title_desc" %}selected{% endif %}>
                                            Title Z-A
                                        </option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="blog_template_{{ component.id }}">Display Template</label>
                                    <select id="blog_template_{{ component.id }}" 
                                            onchange="updateBlogSummaryContent({{ component.id }})">
                                        <option value="cards" {% if component.content.template == "cards" %}selected{% endif %}>
                                            Cards Grid
                                        </option>
                                        <option value="list" {% if component.content.template == "list" %}selected{% endif %}>
                                            List View
                                        </option>
                                        <option value="compact" {% if component.content.template == "compact" %}selected{% endif %}>
                                            Compact List
                                        </option>
                                        <option value="timeline" {% if component.content.template == "timeline" %}selected{% endif %}>
                                            Timeline
                                        </option>
                                    </select>
                                </div>
                            </div>
                        {% else %}
                            <textarea id="content_{{ component.id }}" 
                                      name="component_contents" 
                                      required>{{ component.content|json_encode }}</textarea>
                            <div class="help-text">JSON content</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
            {% else %}
                <div class="empty-state">
                    <p>üì¶ No components yet</p>
                    <p style="font-size: 0.875rem;">Use the sidebar to add your first component!</p>
                </div>
            {% endif %}
        </div>
    </form>
    
    <!-- Add Component Section -->
    <div class="add-component-section">
        <form method="post" id="add-component-form" style="display: flex; align-items: center; gap: 15px;">
            {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% endif %}
            <input type="hidden" name="action" value="add_component">
            <input type="hidden" name="content" value="">
            
            <label for="new_component_type" style="margin: 0; font-weight: 600;">Add Component:</label>
            <select id="new_component_type" name="component_type" required style="flex: 1; max-width: 200px;">
                {% for comp_type in ordered_component_types %}
                <option value="{{ comp_type.type }}">{{ comp_type.label }}</option>
                {% endfor %}
            </select>
            
            <button type="button" class="button" onclick="addNewComponent()">Add</button>
        </form>
    </div>
    
</div>
{% endblock %}