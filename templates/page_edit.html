{% extends "base.html" %}

{% block title %}Edit: {{ page.title }} - {{ super() }}{% endblock %}

{% block head %}
<style>
    /* Component editor - more compact */
    .component-editor {
        margin: var(--space-md) 0;
        padding: var(--space-md) var(--space-lg);
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        transition: all 0.2s ease;
        width: 100%;
        box-sizing: border-box;
    }
    
    .component-editor:hover {
        border-color: var(--gray-300);
        box-shadow: var(--shadow-sm);
    }
    
    /* Highlight animation for newly added components */
    .component-highlight {
        animation: highlightComponent 2s ease-out;
    }
    
    @keyframes highlightComponent {
        0% {
            background-color: #fef3c7;
            border-color: var(--warning-color);
            transform: scale(1.02);
        }
        100% {
            background-color: var(--gray-50);
            border-color: var(--gray-200);
            transform: scale(1);
        }
    }
    
    .component-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-md);
        padding-bottom: var(--space-sm);
        border-bottom: 1px solid var(--gray-200);
    }
    
    .component-info {
        display: flex;
        align-items: center;
        gap: var(--space-md);
    }
    
    .component-type {
        font-weight: 600;
        color: var(--gray-700);
        text-transform: capitalize;
        font-size: 0.9375rem;
    }
    
    .component-position {
        font-size: 0.75rem;
        color: var(--gray-500);
        background: var(--gray-100);
        padding: 2px 8px;
        border-radius: 12px;
    }
    
    .component-actions {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
    }
    
    /* Form layouts - use more columns on wider screens */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-md);
        margin-bottom: var(--space-md);
    }
    
    @media (min-width: 1600px) {
        .form-row {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    @media (max-width: 1200px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
    
    .form-group {
        margin-bottom: var(--space-md);
    }
    
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    
    .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--gray-700);
        font-size: 0.875rem;
    }
    
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-sm);
        font-size: 0.9375rem;
        transition: all 0.15s ease;
        background-color: white;
    }
    
    .form-group input[type="text"]:focus,
    .form-group input[type="number"]:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-group textarea {
        min-height: 120px;
        resize: vertical;
        font-family: var(--font-mono);
        font-size: 0.875rem;
        line-height: 1.5;
        width: 100%;
    }
    
    /* Make content textareas larger on wide screens */
    @media (min-width: 1600px) {
        .form-group.full-width textarea {
            min-height: 200px;
        }
    }
    
    .form-group select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
    
    /* Buttons - more compact */
    .button {
        padding: 6px 14px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.15s ease;
        white-space: nowrap;
    }
    
    .button:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }
    
    .button:active {
        transform: translateY(0);
    }
    
    .button-success {
        background: var(--success-color);
    }
    
    .button-success:hover {
        background: #059669;
    }
    
    .button-danger {
        background: var(--danger-color);
    }
    
    .button-danger:hover {
        background: #dc2626;
    }
    
    .button-secondary {
        background: var(--gray-600);
    }
    
    .button-secondary:hover {
        background: var(--gray-700);
    }
    
    .button-small {
        padding: 4px 8px;
        font-size: 0.75rem;
    }
    
    .button-icon {
        padding: 4px 8px;
        font-size: 1rem;
        min-width: 28px;
        text-align: center;
    }
    
    .button-block {
        display: block;
        width: 100%;
        text-align: center;
    }
    
    /* Sidebar actions */
    .edit-sidebar {
        position: sticky;
        top: 80px;
        height: calc(100vh - 100px);
        overflow-y: auto;
        background-color: var(--gray-50);
    }
    
    .sidebar-actions {
        margin-bottom: var(--space-lg);
    }
    
    .sidebar-actions .button {
        margin-bottom: var(--space-sm);
    }
    
    .sidebar-divider {
        height: 1px;
        background: var(--gray-200);
        margin: var(--space-lg) 0;
    }
    
    .component-shortcuts {
        margin-top: var(--space-lg);
    }
    
    .component-shortcuts h4 {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-500);
        margin-bottom: var(--space-md);
    }
    
    .shortcut-button {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        margin-bottom: var(--space-xs);
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius-sm);
        color: var(--gray-700);
        font-size: 0.875rem;
        font-weight: 500;
        text-align: left;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .shortcut-button:hover {
        background: var(--gray-50);
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateX(2px);
    }
    
    .shortcut-icon {
        width: 20px;
        text-align: center;
    }
    
    .draft-status {
        font-size: 0.875rem;
        color: var(--gray-500);
        background: var(--gray-100);
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 500;
        text-align: center;
        margin-bottom: var(--space-md);
    }
    
    /* Add component section - hidden since we'll use sidebar shortcuts */
    .add-component-section {
        display: none;
    }
    
    .help-text {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 4px;
    }
    
    /* Empty state */
    .empty-state {
        text-align: center;
        padding: var(--space-2xl) var(--space-lg);
        color: var(--gray-500);
    }
    
    /* Override default form max-width for edit mode */
    .edit-mode form.edit-form {
        max-width: none;
        width: 100%;
    }
    
    .edit-mode {
        width: 100%;
    }
    
    /* Override container and content for edit mode to use full width */
    .main-container:has(.edit-sidebar) {
        max-width: none;
        width: 100%;
    }
    
    .main-container:has(.edit-sidebar) .content {
        padding: var(--space-lg) var(--space-xl);
        max-width: none;
    }
    
    @media (max-width: 1400px) {
        .main-container:has(.edit-sidebar) .content {
            padding: var(--space-md) var(--space-lg);
        }
    }
    
    /* Component list */
    .components-list {
        margin-bottom: var(--space-lg);
        width: 100%;
    }
    
    /* Compact blog summary editor */
    .blog-summary-editor .form-row {
        grid-template-columns: 1fr;
    }
    
    .blog-summary-editor .inline-fields {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--space-md);
    }
    
    @media (max-width: 768px) {
        .blog-summary-editor .inline-fields {
            grid-template-columns: 1fr;
        }
    }
    
    /* Template-specific styles */
    .template-preview {
        margin-top: 10px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background: white;
    }
    
    .template-card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .template-highlight {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
    }
    
    .template-quote {
        font-style: italic;
        border-left: 4px solid #6c757d;
        padding-left: 20px;
        color: #495057;
    }
    
    .template-with_title h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #343a40;
    }
    
    /* Drag and drop styles */
    .image-upload-area {
        position: relative;
        transition: all 0.3s ease;
    }
    
    .image-upload-area.drag-over {
        background: #e3f2fd !important;
        border-color: #2196f3 !important;
        transform: scale(1.02);
    }
    
    .image-upload-area.drag-over::after {
        content: "Drop image here";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.25rem;
        font-weight: 600;
        color: #2196f3;
        pointer-events: none;
    }
    
    /* Image preview styles */
    .image-preview img {
        display: block;
        object-fit: contain;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    
    .image-preview img:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        transform: scale(1.02);
    }

    /* Multi-Image Upload - Drop Zone Overlay */
    #multi-upload-overlay {
        position: fixed;
        inset: 0;
        background: rgba(37, 99, 235, 0.9);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s;
        pointer-events: none;
    }
    #multi-upload-overlay.visible {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }
    #multi-upload-overlay .overlay-content {
        text-align: center;
        color: white;
    }
    #multi-upload-overlay .upload-icon {
        font-size: 4rem;
        margin-bottom: var(--space-md);
    }
    #multi-upload-overlay h2 {
        margin: 0 0 var(--space-sm) 0;
        font-size: 2rem;
    }
    #multi-upload-overlay p {
        margin: 0;
        opacity: 0.9;
    }

    /* Multi-Image Upload - Queue Panel */
    #multi-upload-queue {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 320px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.3s;
    }
    #multi-upload-queue.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    .queue-header {
        padding: 12px 16px;
        background: var(--gray-100);
        border-bottom: 1px solid var(--gray-200);
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .queue-title {
        font-weight: 600;
        color: var(--gray-700);
    }
    .queue-count {
        font-size: 0.875rem;
        color: var(--gray-500);
    }
    .queue-items {
        max-height: 300px;
        overflow-y: auto;
    }
    .queue-item {
        padding: 10px 16px;
        border-bottom: 1px solid var(--gray-100);
    }
    .queue-item:last-child {
        border-bottom: none;
    }
    .item-name {
        font-size: 0.875rem;
        color: var(--gray-700);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 4px;
    }
    .item-progress {
        height: 4px;
        background: var(--gray-200);
        border-radius: 2px;
        margin: 6px 0;
        overflow: hidden;
    }
    .progress-bar {
        height: 100%;
        background: var(--primary-color);
        transition: width 0.2s;
        border-radius: 2px;
    }
    .item-status {
        font-size: 0.75rem;
        color: var(--gray-500);
    }
    .queue-item.complete .progress-bar {
        background: var(--success-color);
    }
    .queue-item.complete .item-status {
        color: var(--success-color);
    }
    .queue-item.error .progress-bar {
        background: var(--danger-color);
    }
    .queue-item.error .item-status {
        color: var(--danger-color);
    }
</style>
<script>
function submitComponentsForm(action) {
    const form = document.getElementById('components-form');
    const actionInput = form.querySelector('input[name="action"]');
    actionInput.value = action;

    // Update all text component styles before submission
    const componentIds = form.querySelectorAll('input[name="component_ids"]');
    const componentTypes = form.querySelectorAll('input[name="component_types"]');

    componentIds.forEach((idInput, index) => {
        const componentId = idInput.value;
        const componentType = componentTypes[index]?.value;

        // For text/markdown components, ensure styling is saved
        if (componentType === 'text' || componentType === 'markdown') {
            updateTextStyle(componentId);
        }
    });

    form.submit();
}


function loadSweetAlert() {
    if (window.Swal) return Promise.resolve();
    return new Promise(function(resolve, reject) {
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/.static/css/sweetalert2.min.css';
        document.head.appendChild(link);
        var script = document.createElement('script');
        script.src = '/.static/js/sweetalert2.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

function deleteComponent(componentId) {
    loadSweetAlert().then(function() {
        Swal.fire({
            title: 'Are you sure?',
            text: "This will permanently delete this component",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it',
            cancelButtonText: 'Cancel'
        }).then(function(result) {
            if (result.isConfirmed) {
                var form = document.getElementById('components-form');
                var actionInput = form.querySelector('input[name="action"]');
                actionInput.value = 'delete_component';
                var deleteInput = document.createElement('input');
                deleteInput.type = 'hidden';
                deleteInput.name = 'delete_component_id';
                deleteInput.value = componentId;
                form.appendChild(deleteInput);
                form.submit();
            }
        });
    });
}

function addNewComponentType(componentType) {
    // Create a temporary form to submit the new component
    const form = document.createElement('form');
    form.method = 'post';
    form.style.display = 'none';
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'add_component';
    form.appendChild(actionInput);
    
    const typeInput = document.createElement('input');
    typeInput.type = 'hidden';
    typeInput.name = 'component_type';
    typeInput.value = componentType;
    form.appendChild(typeInput);
    
    const contentInput = document.createElement('input');
    contentInput.type = 'hidden';
    contentInput.name = 'content';
    contentInput.value = getEmptyContentForType(componentType);
    form.appendChild(contentInput);
    
    document.body.appendChild(form);
    form.submit();
}

function getEmptyContentForType(componentType) {
    
    // For all components, including image, just add an empty component
    // The user can upload images after the component is created
    let emptyContent = '';
    switch(componentType) {
        case 'text':
        case 'markdown':
        case 'html':
        case 'code':
            emptyContent = '';
            break;
        case 'image':
            // Create empty image component with placeholder
            emptyContent = JSON.stringify({
                src: '',
                alt: ''
            });
            break;
        case 'blog_summary':
            // Create default blog summary configuration
            emptyContent = JSON.stringify({
                parent_page_id: null,
                display_title: 'Latest Posts',
                item_count: 5,
                show_descriptions: true,
                sort_order: 'created_at_desc',
                template: 'cards'
            });
            break;
        default:
            emptyContent = '';
    }
    
    return emptyContent;
}

function addNewComponent() {
    const addForm = document.getElementById('add-component-form');
    const componentType = addForm.querySelector('select[name="component_type"]').value;
    addNewComponentType(componentType);
}

// Common function to handle file upload
function handleImageFileUpload(file, componentId) {
    // Check file type
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
    if (!validTypes.includes(file.type)) {
        alert('Invalid file type. Please upload JPG, PNG, GIF, WebP, or SVG images.');
        return;
    }
    
    // Check file size (50MB max)
    if (file.size > 50 * 1024 * 1024) {
        alert('File is too large. Maximum size is 50MB.');
        return;
    }
    
    // Generate slug from filename
    const slug = file.name
        .replace(/\.[^/.]+$/, '') // Remove extension
        .toLowerCase()
        .replace(/[^a-z0-9-_]/g, '-') // Replace invalid chars
        .replace(/-+/g, '-') // Remove multiple dashes
        .replace(/^-|-$/g, ''); // Remove leading/trailing dashes
    
    // Create form data
    const formData = new FormData();
    formData.append('image', file);
    formData.append('slug', slug);
    formData.append('title', file.name);
    formData.append('description', '');
    formData.append('component_id', componentId);
    
    // Show loading state
    const uploadArea = document.querySelector(`#component-${componentId} .image-upload-area`);
    if (uploadArea) {
        uploadArea.innerHTML = '<p style="color: #007bff;">Preparing upload...</p>';
    }
        
        try {
            // Create XMLHttpRequest for progress tracking
            const xhr = new XMLHttpRequest();
            
            // Track upload progress
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    const uploadArea = document.querySelector(`#component-${componentId} .image-upload-area`);
                    if (uploadArea) {
                        uploadArea.innerHTML = `
                            <div style="text-align: center;">
                                <p style="color: #007bff; margin-bottom: 10px;">Uploading image...</p>
                                <div style="width: 100%; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${percentComplete}%; height: 100%; background-color: #007bff; transition: width 0.3s ease;"></div>
                                </div>
                                <p style="color: #6c757d; margin-top: 5px; font-size: 0.875rem;">${percentComplete}%</p>
                            </div>
                        `;
                    }
                }
            });
            
            // Handle completion
            xhr.onload = async function() {
                if (xhr.status === 200) {
                    try {
                        const result = JSON.parse(xhr.responseText);
                        if (result.success) {
                            // Update the component content
                            updateImageComponent(componentId, result);
                        } else {
                            throw new Error(result.error || 'Upload failed');
                        }
                    } catch (parseError) {
                        console.error('Failed to parse response:', parseError);
                        alert('Failed to process upload response. Please try again.');
                        location.reload();
                    }
                } else {
                    const errorMsg = xhr.status === 413 ? 'File is too large. Maximum size is 50MB.' :
                                    xhr.status === 415 ? 'Invalid image format. Please upload JPG, PNG, GIF, WebP, or SVG.' :
                                    'Failed to upload image. Please try again.';
                    alert(errorMsg);
                    location.reload();
                }
            };
            
            // Handle errors
            xhr.onerror = function() {
                console.error('Upload error');
                alert('Network error during upload. Please check your connection and try again.');
                location.reload();
            };
            
            // Send the request
            xhr.open('POST', './.upload-component-image');
            xhr.send(formData);
            
        } catch (error) {
            console.error('Upload error:', error);
            alert('Failed to upload image. Please try again.');
            location.reload();
        }
}

function uploadImageForComponent(componentId) {
    // Create a hidden file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    
    fileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        handleImageFileUpload(file, componentId);
    };
    
    // Trigger file selection
    fileInput.click();
}

function changeImage(componentId) {
    // Same as upload, just for existing images
    uploadImageForComponent(componentId);
}

function updateImageSlug(componentId, newSlug) {
    // Validate slug - only allow lowercase letters, numbers, hyphens, and underscores
    const validSlug = newSlug.toLowerCase().replace(/[^a-z0-9-_]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
    
    // Update the input value with validated slug
    const slugInput = document.getElementById(`slug_${componentId}`);
    if (slugInput && slugInput.value !== validSlug) {
        slugInput.value = validSlug;
    }
    
    // Update the hidden content input
    const contentInput = document.getElementById(`content_${componentId}`);
    if (contentInput) {
        try {
            const content = JSON.parse(contentInput.value);
            content.slug = validSlug;
            contentInput.value = JSON.stringify(content);
            
            // Update the image preview URL (keep using preview handler)
            const imgPreview = document.querySelector(`#component-${componentId} .image-preview img`);
            if (imgPreview) {
                // Keep using the preview handler - slug changes don't affect preview URL
                // imgPreview.src = `/.image-preview?component_id=${componentId}`;
            }
        } catch (e) {
            console.error('Failed to update slug:', e);
        }
    }
}

function updateImageDisplaySize(componentId) {
    const widthInput = document.getElementById(`display_width_${componentId}`);
    const heightInput = document.getElementById(`display_height_${componentId}`);
    const contentInput = document.getElementById(`content_${componentId}`);
    
    if (contentInput) {
        try {
            const content = JSON.parse(contentInput.value);
            
            // Store display dimensions (empty string means auto)
            content.display_width = widthInput.value.trim();
            content.display_height = heightInput.value.trim();
            
            contentInput.value = JSON.stringify(content);
            
            // Update the preview image style if needed
            const imgPreview = document.querySelector(`#component-${componentId} .image-preview img`);
            if (imgPreview) {
                if (content.display_width) {
                    imgPreview.style.width = content.display_width;
                } else {
                    imgPreview.style.width = '';
                }
                
                if (content.display_height) {
                    imgPreview.style.height = content.display_height;
                } else {
                    imgPreview.style.height = '';
                }
            }
        } catch (e) {
            console.error('Failed to update display size:', e);
        }
    }
}

function updateTextStyle(componentId) {
    const bgColorSelect = document.getElementById(`bg_color_${componentId}`);
    const textAlignSelect = document.getElementById(`text_align_${componentId}`);
    const paddingSelect = document.getElementById(`padding_${componentId}`);
    const contentTextarea = document.getElementById(`content_${componentId}`);
    const hiddenInput = document.getElementById(`content_json_${componentId}`);

    if (!contentTextarea || !hiddenInput) {
        console.error('Could not find content elements for component', componentId);
        return;
    }

    // Get current values (use defaults if selects don't exist yet)
    const bgColor = bgColorSelect?.value || '';
    const textAlign = textAlignSelect?.value || 'left';
    const padding = paddingSelect?.value || 'medium';
    const text = contentTextarea.value;

    // Create updated content object with styling
    const updatedContent = {
        text: text,
        background_color: bgColor,
        text_align: textAlign,
        padding: padding
    };

    hiddenInput.value = JSON.stringify(updatedContent);
}

function updateImageComponent(componentId, imageData) {
    // Create the new content object
    const newContent = {
        slug: imageData.slug,
        title: imageData.title || imageData.slug,
        description: imageData.description || '',
        format: imageData.format,
        file_path: imageData.file_path,
        original_name: imageData.original_name,
        mime_type: imageData.mime_type,
        size: imageData.size,
        width: imageData.width,
        height: imageData.height,
        display_width: '',
        display_height: ''
    };
    
    // Update the UI to show the uploaded image
    const componentEditor = document.getElementById(`component-${componentId}`);
    const contentGroup = componentEditor.querySelector('.form-group.full-width');
    
    if (!contentGroup) {
        console.error('Could not find content group for component', componentId);
        alert('UI update failed. Please refresh the page.');
        return;
    }
    
    // Add success message temporarily
    const successMessage = `
        <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 10px; text-align: center;">
            ‚úÖ Image uploaded successfully!
        </div>
    `;
    
    // Important: Use proper escaping for the JSON in the value attribute
    const escapedContent = JSON.stringify(newContent).replace(/"/g, '&quot;');
    
    contentGroup.innerHTML = successMessage + `
        <label for="content_${componentId}">Content</label>
        <div class="image-preview" style="margin-bottom: 10px;">
            <img src="/.image-preview?component_id=${componentId}&_t=${Date.now()}"
                 alt="${imageData.description || imageData.title}"
                 style="max-width: 200px; max-height: 200px; border: 1px solid #dee2e6; border-radius: 4px;">
        </div>
        <input type="hidden" 
               id="content_${componentId}" 
               name="component_contents" 
               value="${escapedContent}">
        <div class="image-info" style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
            <div class="form-row" style="margin-bottom: 10px;">
                <div class="form-group" style="margin: 0;">
                    <label for="slug_${componentId}" style="font-size: 0.75rem; margin-bottom: 4px;">Slug</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="text" 
                               id="slug_${componentId}" 
                               value="${imageData.slug}" 
                               onchange="updateImageSlug(${componentId}, this.value)"
                               style="flex: 1; padding: 6px 10px; border: 1px solid var(--gray-300); border-radius: var(--border-radius-sm); font-size: 0.9375rem;">
                        <span style="color: #6c757d; font-size: 0.875rem;">.${imageData.format}</span>
                    </div>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label style="font-size: 0.75rem; margin-bottom: 4px;">Display Size</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="text" 
                               id="display_width_${componentId}" 
                               value="" 
                               placeholder="auto"
                               onchange="updateImageDisplaySize(${componentId})"
                               style="width: 60px; padding: 6px 10px; border: 1px solid var(--gray-300); border-radius: var(--border-radius-sm); font-size: 0.9375rem;">
                        <span style="color: #6c757d;">√ó</span>
                        <input type="text" 
                               id="display_height_${componentId}" 
                               value="" 
                               placeholder="auto"
                               onchange="updateImageDisplaySize(${componentId})"
                               style="width: 60px; padding: 6px 10px; border: 1px solid var(--gray-300); border-radius: var(--border-radius-sm); font-size: 0.9375rem;">
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 20px; font-size: 0.75rem; color: #6c757d;">
                <span><strong>Format:</strong> ${imageData.format}</span>
                <span><strong>Size:</strong> ${(imageData.size / 1024).toFixed(2)} KB</span>
                ${imageData.width && imageData.height ? `<span><strong>Dimensions:</strong> ${imageData.width}√ó${imageData.height}</span>` : ''}
            </div>
        </div>
        <button type="button" 
                class="button button-secondary button-small" 
                style="margin-top: 10px;"
                onclick="changeImage(${componentId})">
            üîÑ Change Image
        </button>
    `;
    
    // Remove success message after 3 seconds
    setTimeout(() => {
        const successDiv = contentGroup.querySelector('div[style*="background: #d4edda"]');
        if (successDiv) {
            successDiv.style.transition = 'opacity 0.5s ease';
            successDiv.style.opacity = '0';
            setTimeout(() => successDiv.remove(), 500);
        }
    }, 3000);
    
    // Add highlight animation to the component
    componentEditor.classList.add('component-highlight');
    setTimeout(() => {
        componentEditor.classList.remove('component-highlight');
    }, 2000);
    
    // Log for debugging
    console.log('Image component updated:', componentId, newContent);
    
    // Auto-save the draft
    setTimeout(() => {
        submitComponentsForm('save_draft');
    }, 500);
}

function moveComponent(componentId, direction) {
    // Save all current component data and move the component
    const form = document.getElementById('components-form');
    const actionInput = form.querySelector('input[name="action"]');
    actionInput.value = 'move_component';

    // Add the component ID and direction
    const moveIdInput = document.createElement('input');
    moveIdInput.type = 'hidden';
    moveIdInput.name = 'move_component_id';
    moveIdInput.value = componentId;
    form.appendChild(moveIdInput);

    const directionInput = document.createElement('input');
    directionInput.type = 'hidden';
    directionInput.name = 'move_direction';
    directionInput.value = direction;
    form.appendChild(directionInput);

    // Add hash to form action so page scrolls to the moved component after reload
    form.action = window.location.pathname + '#component-' + componentId;

    // Submit the form
    form.submit();
}

function updateBlogSummaryContent(componentId) {
    const contentInput = document.getElementById(`content_${componentId}`);
    if (!contentInput) return;
    
    // Get all the form values
    const parentSelect = document.getElementById(`blog_parent_${componentId}`);
    const titleInput = document.getElementById(`blog_title_${componentId}`);
    const countInput = document.getElementById(`blog_count_${componentId}`);
    const descriptionsCheck = document.getElementById(`blog_descriptions_${componentId}`);
    const sortSelect = document.getElementById(`blog_sort_${componentId}`);

    // Build the content object
    const content = {
        parent_page_id: parentSelect.value ? parseInt(parentSelect.value) : null,
        display_title: titleInput.value.trim(),
        item_count: parseInt(countInput.value) || 5,
        show_descriptions: descriptionsCheck.checked,
        sort_order: sortSelect.value
    };
    
    // Update the hidden input
    contentInput.value = JSON.stringify(content);
}

// Smooth scroll to component if there's a hash in the URL
document.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash) {
        const element = document.querySelector(window.location.hash);
        if (element) {
            // Wait a bit for the page to fully render
            setTimeout(() => {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Add a highlight effect
                element.classList.add('component-highlight');
                setTimeout(() => {
                    element.classList.remove('component-highlight');
                }, 2000);
            }, 100);
        }
    }
    
    // Set up drag and drop for all image upload areas
    document.querySelectorAll('.image-upload-area').forEach(uploadArea => {
        const componentId = uploadArea.closest('.component-editor').id.replace('component-', '');
        
        // Make the entire area clickable
        uploadArea.addEventListener('click', function(e) {
            // Don't trigger if clicking on a button
            if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
                uploadImageForComponent(componentId);
            }
        });
        
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop area when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false);
        });
        
        // Handle dropped files
        uploadArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleImageFileUpload(files[0], componentId);
            }
        }, false);
    });
    
    // Set up paste functionality for the entire page
    document.addEventListener('paste', function(e) {
        // Check if we're in an editable element
        const activeElement = document.activeElement;
        if (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA') {
            return; // Let normal paste behavior happen
        }
        
        // Check if there are any image upload areas visible
        const visibleUploadAreas = document.querySelectorAll('.image-upload-area');
        if (visibleUploadAreas.length === 0) return;
        
        // Get clipboard data
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const file = items[i].getAsFile();
                
                // If there's only one upload area, use it
                if (visibleUploadAreas.length === 1) {
                    const componentId = visibleUploadAreas[0].closest('.component-editor').id.replace('component-', '');
                    handleImageFileUpload(file, componentId);
                    e.preventDefault();
                } else {
                    // Multiple upload areas - prompt user
                    alert('Multiple image components found. Please click on the specific upload area where you want to paste the image.');
                }
                break;
            }
        }
    });
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}
</script>
<script src="/.static/js/multi-upload.js"></script>
{% endblock %}

{% block sidebar %}
<div class="edit-sidebar">
    <!-- Draft Status -->
    <div class="draft-status">Editing Draft</div>
    
    <!-- Action Buttons -->
    <div class="sidebar-actions">
        <button type="button" class="button button-block" onclick="submitComponentsForm('save_draft')">
            üíæ Save Draft
        </button>
        <button type="button" class="button button-success button-block" onclick="submitComponentsForm('publish_draft')">
            üöÄ Save &amp; Publish
        </button>
        <form method="post" style="margin: 0;">
            {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% endif %}
            <input type="hidden" name="action" value="discard_draft">
            <button type="submit" class="button button-danger button-block" 
                    onclick="return confirm('Are you sure you want to discard all draft changes?')">
                ‚ùå Discard Draft
            </button>
        </form>
        <a href="{{ current_path }}" class="button button-secondary button-block">
            ‚Üê Back to Page
        </a>
    </div>
    
    <div class="sidebar-divider"></div>
    
    <!-- Component Shortcuts -->
    <div class="component-shortcuts">
        <h4>Add Component</h4>
        {% for comp_type in ordered_component_types %}
        <button type="button" class="shortcut-button" onclick="addNewComponentType('{{ comp_type.type }}')">
            <span class="shortcut-icon">
                {% if comp_type.type == "text" %}üìù{% elif comp_type.type == "markdown" %}üìÑ{% elif comp_type.type == "html" %}üåê{% elif comp_type.type == "code" %}üíª{% elif comp_type.type == "image" %}üñºÔ∏è{% elif comp_type.type == "blog_summary" %}üì∞{% else %}üì¶{% endif %}
            </span>
            {{ comp_type.label }}
        </button>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="edit-mode">
    <!-- Components Form -->
    <form method="post" id="components-form" class="edit-form">
        {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {% endif %}
        <input type="hidden" name="action" value="save_draft">
        
        <!-- Components -->
        <div class="components-list">
            {% if components %}
                {% for component in components %}
                <div class="component-editor" id="component-{{ component.id }}">
                    <div class="component-header">
                        <div class="component-info">
                            <span class="component-type">{{ component.component_type|title }} Component</span>
                            <span class="component-position">#{{ component.position + 1 }}</span>
                        </div>
                        <div class="component-actions">
                            <!-- Debug: loop.index0={{ loop.index0 }}, loop.first={{ loop.first }}, loop.last={{ loop.last }}, total={{ components|length }} -->
                            {% if not loop.first %}
                            <button type="button" class="button button-secondary button-icon" onclick="moveComponent({{ component.id }}, 'up')" title="Move Up">‚Üë</button>
                            {% else %}
                            <!-- Move up button hidden: loop.first is true -->
                            {% endif %}
                            {% if not loop.last %}
                            <button type="button" class="button button-secondary button-icon" onclick="moveComponent({{ component.id }}, 'down')" title="Move Down">‚Üì</button>
                            {% else %}
                            <!-- Move down button hidden: loop.last is true -->
                            {% endif %}
                            <button type="button" class="button button-danger button-small" onclick="deleteComponent({{ component.id }})">Delete</button>
                        </div>
                    </div>
                    
                    <input type="hidden" name="component_ids" value="{{ component.id }}">
                    <input type="hidden" name="component_types" value="{{ component.component_type }}">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="title_{{ component.id }}">Title (optional)</label>
                            <input type="text" 
                                   id="title_{{ component.id }}" 
                                   name="component_titles" 
                                   value="{{ component.title|default(value='') }}"
                                   placeholder="Enter component title...">
                        </div>
                        
                        <div class="form-group">
                            <label for="template_{{ component.id }}">Display Template</label>
                            <select id="template_{{ component.id }}" name="component_templates">
                                {% set templates = get_component_templates(type=component.component_type) %}
                                {% for template in templates %}
                                    <option value="{{ template }}" {% if component.template == template %}selected{% endif %}>
                                        {{ template | replace(from="_", to=" ") | title }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="content_{{ component.id }}">Content</label>
                        {% if component.component_type == "text" or component.component_type == "markdown" %}
                            <textarea id="content_{{ component.id }}"
                                      oninput="updateTextStyle({{ component.id }})"
                                      required>{{ component.content.text|default(value='') }}</textarea>
                            <input type="hidden"
                                   id="content_json_{{ component.id }}"
                                   name="component_contents"
                                   value="{{ component.content | json_encode() }}">
                            <div class="help-text">
                                {% if component.component_type == "markdown" %}
                                Markdown formatting is supported
                                {% else %}
                                Plain text or HTML
                                {% endif %}
                            </div>

                            <!-- Text styling options -->
                            {% set bg_color = component.content.background_color | default(value="") %}
                            {% set txt_align = component.content.text_align | default(value="left") %}
                            {% set txt_padding = component.content.padding | default(value="medium") %}
                            <div class="text-style-options" style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                <div class="form-group" style="margin: 0; flex: 1; min-width: 120px;">
                                    <label style="font-size: 0.75rem;">Background</label>
                                    <select id="bg_color_{{ component.id }}" onchange="updateTextStyle({{ component.id }})">
                                        <option value="" {% if bg_color == "" %}selected{% endif %}>Aucun</option>
                                        <option value="sand" {% if bg_color == "sand" %}selected{% endif %}>Sable</option>
                                        <option value="sea" {% if bg_color == "sea" %}selected{% endif %}>Mer</option>
                                        <option value="grass" {% if bg_color == "grass" %}selected{% endif %}>Herbe</option>
                                        <option value="white" {% if bg_color == "white" %}selected{% endif %}>Blanc</option>
                                        <option value="dark" {% if bg_color == "dark" %}selected{% endif %}>Sombre</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0; flex: 1; min-width: 120px;">
                                    <label style="font-size: 0.75rem;">Alignement</label>
                                    <select id="text_align_{{ component.id }}" onchange="updateTextStyle({{ component.id }})">
                                        <option value="left" {% if txt_align == "left" %}selected{% endif %}>Gauche</option>
                                        <option value="center" {% if txt_align == "center" %}selected{% endif %}>Centr√©</option>
                                        <option value="right" {% if txt_align == "right" %}selected{% endif %}>Droite</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0; flex: 1; min-width: 120px;">
                                    <label style="font-size: 0.75rem;">Padding</label>
                                    <select id="padding_{{ component.id }}" onchange="updateTextStyle({{ component.id }})">
                                        <option value="none" {% if txt_padding == "none" %}selected{% endif %}>Aucun</option>
                                        <option value="small" {% if txt_padding == "small" %}selected{% endif %}>Petit</option>
                                        <option value="medium" {% if txt_padding == "medium" %}selected{% endif %}>Moyen</option>
                                        <option value="large" {% if txt_padding == "large" %}selected{% endif %}>Grand</option>
                                    </select>
                                </div>
                            </div>
                        {% elif component.component_type == "html" %}
                            <textarea id="content_{{ component.id }}" 
                                      name="component_contents" 
                                      required>{{ component.content.html|default(value='') }}</textarea>
                            <div class="help-text">Raw HTML content</div>
                        {% elif component.component_type == "code" %}
                            <textarea id="content_{{ component.id }}" 
                                      name="component_contents" 
                                      required>{{ component.content.code|default(value='') }}</textarea>
                            <div class="help-text">Code content</div>
                        {% elif component.component_type == "image" %}
                            {% if component.content.slug %}
                                <!-- New format with uploaded image -->
                                <div class="image-preview" style="margin-bottom: 10px;">
                                    <img src="/.image-preview?component_id={{ component.id }}"
                                         alt="{{ component.content.alt_text | default(value='') }}"
                                         style="max-width: 200px; max-height: 200px; border: 1px solid #dee2e6; border-radius: 4px;">
                                </div>
                                <input type="hidden" 
                                       id="content_{{ component.id }}" 
                                       name="component_contents" 
                                       value="{{ component.content|json_encode }}">
                                <div class="image-info" style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                    <div class="form-row" style="margin-bottom: 10px;">
                                        <div class="form-group" style="margin: 0;">
                                            <label for="slug_{{ component.id }}" style="font-size: 0.75rem; margin-bottom: 4px;">Slug</label>
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <input type="text"
                                                       id="slug_{{ component.id }}"
                                                       value="{{ component.content.slug | default(value='') }}"
                                                       onchange="updateImageSlug({{ component.id }}, this.value)"
                                                       style="flex: 1;">
                                                <span style="color: #6c757d; font-size: 0.875rem;">.{{ component.content.format | default(value='') }}</span>
                                            </div>
                                        </div>
                                        <div class="form-group" style="margin: 0;">
                                            <label style="font-size: 0.75rem; margin-bottom: 4px;">Display Size</label>
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <input type="text" 
                                                       id="display_width_{{ component.id }}" 
                                                       value="{{ component.content.display_width|default(value='') }}" 
                                                       placeholder="auto"
                                                       onchange="updateImageDisplaySize({{ component.id }})"
                                                       style="width: 60px;">
                                                <span style="color: #6c757d;">√ó</span>
                                                <input type="text" 
                                                       id="display_height_{{ component.id }}" 
                                                       value="{{ component.content.display_height|default(value='') }}" 
                                                       placeholder="auto"
                                                       onchange="updateImageDisplaySize({{ component.id }})"
                                                       style="width: 60px;">
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 20px; font-size: 0.75rem; color: #6c757d;">
                                        <span><strong>Format:</strong> {{ component.content.format | default(value='') }}</span>
                                        {% if component.content.size %}
                                        <span><strong>Size:</strong> {{ (component.content.size / 1024)|round(precision=2) }} KB</span>
                                        {% endif %}
                                        {% if component.content.width and component.content.height %}
                                        <span><strong>Dimensions:</strong> {{ component.content.width }}x{{ component.content.height }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <button type="button" 
                                        class="button button-secondary button-small" 
                                        style="margin-top: 10px;"
                                        onclick="changeImage({{ component.id }})">
                                    üîÑ Change Image
                                </button>
                            {% else %}
                                <!-- No image uploaded yet -->
                                <div class="image-upload-area" style="border: 2px dashed #007bff; border-radius: 8px; padding: 30px 20px; text-align: center; background: #f8f9fa; cursor: pointer;">
                                    <p style="margin: 0 0 15px 0; color: #495057; font-size: 1.125rem;">
                                        <strong>Drop image here</strong>
                                    </p>
                                    <p style="margin: 0 0 15px 0; color: #6c757d;">
                                        or
                                    </p>
                                    <input type="hidden" 
                                           id="content_{{ component.id }}" 
                                           name="component_contents" 
                                           value="{{ component.content|json_encode }}">
                                    <button type="button" 
                                            class="button" 
                                            onclick="uploadImageForComponent({{ component.id }})">
                                        üìÅ Browse Files
                                    </button>
                                    <div class="help-text" style="margin-top: 15px; font-size: 0.875rem;">
                                        <p style="margin: 5px 0;">Supports: JPG, PNG, GIF, WebP, SVG (max 50MB)</p>
                                        <p style="margin: 5px 0;">üí° Tip: You can also paste images from clipboard!</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% elif component.component_type == "blog_summary" %}
                            <div class="blog-summary-editor">
                                <input type="hidden" 
                                       id="content_{{ component.id }}" 
                                       name="component_contents" 
                                       value="{{ component.content|json_encode }}">
                                
                                <div class="form-group">
                                    <label for="blog_parent_{{ component.id }}">Parent Page</label>
                                    <select id="blog_parent_{{ component.id }}" 
                                            onchange="updateBlogSummaryContent({{ component.id }})"
                                            style="width: 100%;">
                                        <option value="">Select a parent page...</option>
                                        {% for p in all_pages %}
                                            <option value="{{ p.id }}" 
                                                    {% if component.content.parent_page_id == p.id %}selected{% endif %}>
                                                {{ p.title }} ({{ p.slug }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="blog_title_{{ component.id }}">Display Title</label>
                                    <input type="text" 
                                           id="blog_title_{{ component.id }}" 
                                           value="{{ component.content.display_title|default(value='') }}"
                                           onchange="updateBlogSummaryContent({{ component.id }})"
                                           placeholder="e.g., Latest Posts">
                                </div>
                                
                                <div class="form-group">
                                    <label for="blog_count_{{ component.id }}">Number of Items</label>
                                    <input type="number" 
                                           id="blog_count_{{ component.id }}" 
                                           value="{{ component.content.item_count|default(value=5) }}"
                                           min="1" max="50"
                                           onchange="updateBlogSummaryContent({{ component.id }})">
                                </div>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" 
                                               id="blog_descriptions_{{ component.id }}"
                                               {% if component.content.show_descriptions %}checked{% endif %}
                                               onchange="updateBlogSummaryContent({{ component.id }})">
                                        Show descriptions
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label for="blog_sort_{{ component.id }}">Sort Order</label>
                                    <select id="blog_sort_{{ component.id }}" 
                                            onchange="updateBlogSummaryContent({{ component.id }})">
                                        <option value="created_at_desc" {% if component.content.sort_order == "created_at_desc" %}selected{% endif %}>
                                            Newest First
                                        </option>
                                        <option value="created_at_asc" {% if component.content.sort_order == "created_at_asc" %}selected{% endif %}>
                                            Oldest First
                                        </option>
                                        <option value="title_asc" {% if component.content.sort_order == "title_asc" %}selected{% endif %}>
                                            Title A-Z
                                        </option>
                                        <option value="title_desc" {% if component.content.sort_order == "title_desc" %}selected{% endif %}>
                                            Title Z-A
                                        </option>
                                    </select>
                                </div>
                                
                            </div>
                        {% else %}
                            <textarea id="content_{{ component.id }}" 
                                      name="component_contents" 
                                      required>{{ component.content|json_encode }}</textarea>
                            <div class="help-text">JSON content</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
            {% else %}
                <div class="empty-state">
                    <p>üì¶ No components yet</p>
                    <p style="font-size: 0.875rem;">Use the sidebar to add your first component!</p>
                </div>
            {% endif %}
        </div>
    </form>
    
    <!-- Add Component Section -->
    <div class="add-component-section">
        <form method="post" id="add-component-form" style="display: flex; align-items: center; gap: 15px;">
            {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            {% endif %}
            <input type="hidden" name="action" value="add_component">
            <input type="hidden" name="content" value="">
            
            <label for="new_component_type" style="margin: 0; font-weight: 600;">Add Component:</label>
            <select id="new_component_type" name="component_type" required style="flex: 1; max-width: 200px;">
                {% for comp_type in ordered_component_types %}
                <option value="{{ comp_type.type }}">{{ comp_type.label }}</option>
                {% endfor %}
            </select>
            
            <button type="button" class="button" onclick="addNewComponent()">Add</button>
        </form>
    </div>
    
</div>
{% endblock %}